test_name: Make sure investigation job with invalid request is handled correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation with invalid request
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations"
      json:
        key:
          globalAssetId111: urn:uuid:2c57b0e9-a653-411d-bdcd-64787e9fd3a7
          bpn111: BPNL00000003CRHK
        incidentBPNSs111:
          - BPNS00000003B6LU
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 400
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:errors_for_invalid_investigation_request_are_correct
      json:
        statusCode: BAD_REQUEST
        error: "Invalid Arguments."
      headers:
        content-type: application/json


---


test_name: Make sure investigation job with valid globalAssetId and BPN is processed correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation job with valid globalAssetId
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations"
      json:
        key:
          # Tested with Vehicle A
          globalAssetId: urn:uuid:0733946c-59c6-41ae-9570-cb43a6e4c79e
          bpn: BPNL00000003AYRE
        bomLifecycle: asPlanned
        callbackUrl: http://testikus.com
        incidentBPNSs:
          - BPNS00000003B6LU
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - &verify_ESS_job_response_with_desired_test_steps_and_wait_up_to_15_minutes_for_COMPLETED
    name: verify job response with desired test steps and wait for desired job status
    max_retries: 30
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 200
      json:
        job:
          state: COMPLETED
    delay_after: 30

  - name: get response for created investigation
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:supplyChainImpacted_is_as_expected
          extra_kwargs:
            expectedSupplyChainImpacted: "Yes"
        - function: local.testing.api-tests.tavern_helpers:ESS_job_parameter_are_as_requested
      headers:
        content-type: application/json


---


test_name: Make sure investigation job with valid globalAssetId for unknown BPN is processed correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation job with valid globalAssetId for unknown BPN
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations"
      json:
        key:
          # Tested with Vehicle A
          globalAssetId: urn:uuid:0733946c-59c6-41ae-9570-cb43a6e4c79e
          bpn: BPNL00000003AYRE
        bomLifecycle: asPlanned
        callbackUrl: http://testikus.com
        incidentBPNSs:
          - BPNS00ARBITRARY9
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_ESS_job_response_with_desired_test_steps_and_wait_up_to_15_minutes_for_COMPLETED

  - name: get response for created investigation
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:supplyChainImpacted_is_as_expected
          extra_kwargs:
            expectedSupplyChainImpacted: "No"
        - function: local.testing.api-tests.tavern_helpers:ESS_job_parameter_are_as_requested
      headers:
        content-type: application/json


---


test_name: Make sure investigation job with unknown globalAssetId and valid BPN is processed correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation with unknown globalAssetId
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations"
      json:
        key:
          globalAssetId: urn:uuid:2c57b0e9-a653-411d-bdcd-64787e955555
          bpn: BPNL00000003AYRE
        incidentBPNSs:
          - BPNS00000003B6LU
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_ESS_job_response_with_desired_test_steps_and_wait_up_to_15_minutes_for_COMPLETED

  - name: get response for created investigation
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:supplyChainImpacted_is_as_expected
          extra_kwargs:
            expectedSupplyChainImpacted: "Unknown"
        - function: local.testing.api-tests.tavern_helpers:ESS_job_parameter_are_as_requested
      headers:
        content-type: application/json


---


test_name: Make sure investigation job with valid globalAssetId and valid BPN but partial supply chain is processed correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation job with valid globalAssetId and valid BPN
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations"
      json:
        key:
          #tested with Vehicle D
          globalAssetId: urn:uuid:3a2a1ca9-c6c1-49c7-a7ae-1dfc5fb9881f
          bpn: BPNL00ARBITRARY8
        bomLifecycle: asPlanned
        callbackUrl: http://testikus.com
        incidentBPNSs:
          - BPNS0ARBITRARY11
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_ESS_job_response_with_desired_test_steps_and_wait_up_to_15_minutes_for_COMPLETED

  - name: get response for created investigation
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:supplyChainImpacted_is_as_expected
          extra_kwargs:
            expectedSupplyChainImpacted: "Yes"
        - function: local.testing.api-tests.tavern_helpers:ESS_job_parameter_are_as_requested
      headers:
        content-type: application/json



---


test_name: Make sure investigation job with valid globalAssetId and valid BPN but not reachable incidentBPN is processed correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation job with valid globalAssetId and valid BPN but not reachable incidentBPN
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations"
      json:
        key:
          #tested with Vehicle B
          globalAssetId: urn:uuid:68904173-ad59-4a77-8412-3e73fcafbd8b
          bpn: BPNL00000003B6LU
        bomLifecycle: asPlanned
        callbackUrl: http://testikus.com
        incidentBPNSs:
          - BPNS00000003AXS3
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_ESS_job_response_with_desired_test_steps_and_wait_up_to_15_minutes_for_COMPLETED

  - name: get response for created investigation
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:supplyChainImpacted_is_as_expected
          extra_kwargs:
            expectedSupplyChainImpacted: "Unknown"
        - function: local.testing.api-tests.tavern_helpers:ESS_job_parameter_are_as_requested
      headers:
        content-type: application/json


---


test_name: Make sure investigation job with several relationships for valid globalAssetId and BPN is processed correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation job with valid globalAssetId with several relationships
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations"
      json:
        key:
          # Tested with Vehicle C
          globalAssetId: urn:uuid:1c7a25ea-0490-4944-b9c9-d8c666d47958
          bpn: BPNL00ARBITRARY4
        incidentBPNSs:
          - BPNS00ARBITRARY7
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_ESS_job_response_with_desired_test_steps_and_wait_up_to_15_minutes_for_COMPLETED

  - name: get response for created investigation
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:supplyChainImpacted_is_as_expected
          extra_kwargs:
            expectedSupplyChainImpacted: "Yes"
        - function: local.testing.api-tests.tavern_helpers:relationships_for_BPN_investigations_contains_several_childs
        - function: local.testing.api-tests.tavern_helpers:ESS_job_parameter_are_as_requested
        - function: local.testing.api-tests.tavern_helpers:tombstones_are_empty
        - function: local.testing.api-tests.tavern_helpers:relationships_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:submodels_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:check_timestamps_for_completed_jobs
      headers:
        content-type: application/json


---


test_name: Make sure investigation job for globalAssetId with missing PartSiteInformationAsPlanned is processed correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation job with valid globalAssetId
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations"
      json:
        key:
          globalAssetId: urn:uuid:b0faace3-d41f-45b8-9573-175a33efbaaf
          bpn: BPNL00ARBITRARY8
        bomLifecycle: asPlanned
        callbackUrl: http://testikus.com
        incidentBPNSs:
          - BPNL0ARBITRARY11
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_ESS_job_response_with_desired_test_steps_and_wait_up_to_15_minutes_for_COMPLETED

  - name: get response for created investigation
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:supplyChainImpacted_is_as_expected
          extra_kwargs:
            expectedSupplyChainImpacted: "Unknown"
        - function: local.testing.api-tests.tavern_helpers:tombstone_for_EssValidation_are_correct
          extra_kwargs:
            expectedTombstone: "AspectType 'PartSiteInformationAsPlanned' not found in Job."
      headers:
        content-type: application/json


---


test_name: Make sure investigation job for globalAssetId with missing BPNS in PartSiteInformationAsPlanned is processed correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation job with valid globalAssetId
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations"
      json:
        key:
          globalAssetId: urn:uuid:f5024c70-6c4f-4ec5-b23b-aa6a91110611
          bpn: BPNL00ARBITRARY8
        bomLifecycle: asPlanned
        callbackUrl: http://testikus.com
        incidentBPNSs:
          - BPNL0ARBITRARY11
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_ESS_job_response_with_desired_test_steps_and_wait_up_to_15_minutes_for_COMPLETED

  - name: get response for created investigation and check results
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:supplyChainImpacted_is_as_expected
          extra_kwargs:
            expectedSupplyChainImpacted: "Unknown"
        - function: local.testing.api-tests.tavern_helpers:tombstone_for_EssValidation_are_correct
          extra_kwargs:
            expectedTombstone: "'PartSiteInformationAsPlanned' exists, but catenaXSiteId could not be found."
      headers:
        content-type: application/json


---


test_name: Make sure first level supplier BPNL in investigation job with four level request has been detected correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation job with valid globalAssetId
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations"
      json:
        key:
          # Tested with Vehicle A
          globalAssetId: urn:uuid:0733946c-59c6-41ae-9570-cb43a6e4c79e
          bpn: BPNL00000003AYRE
        bomLifecycle: asPlanned
        callbackUrl: http://testikus.com
        incidentBPNSs:
          - BPNS00000003B6LU
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_ESS_job_response_with_desired_test_steps_and_wait_up_to_15_minutes_for_COMPLETED

  - name: get response for created investigation and check results
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:supplyChainImpacted_is_as_expected
          extra_kwargs:
            expectedSupplyChainImpacted: "Yes"
        - function: local.testing.api-tests.tavern_helpers:ESS_job_parameter_are_as_requested
        - function: local.testing.api-tests.tavern_helpers:supplyChainFirstLevelBpn_is_as_expected
          extra_kwargs:
            expectedBpnl: BPNL00ARBITRARY1
      headers:
        content-type: application/json


---


test_name: Make sure first level supplier BPNL in investigation job with several impacted nodes has been detected correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation job with valid globalAssetId
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations"
      json:
        key:
          # Tested with Vehicle A on second level
          globalAssetId: urn:uuid:aad27ddb-43aa-4e42-98c2-01e529ef127c
          bpn: BPNL00ARBITRARY1
        bomLifecycle: asPlanned
        callbackUrl: http://testikus.com
        incidentBPNSs:
          - BPNS00000003B6LU
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_ESS_job_response_with_desired_test_steps_and_wait_up_to_15_minutes_for_COMPLETED

  - name: get response for created investigation and check results
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:supplyChainImpacted_is_as_expected
          extra_kwargs:
            expectedSupplyChainImpacted: "Yes"
        - function: local.testing.api-tests.tavern_helpers:ESS_job_parameter_are_as_requested
        - function: local.testing.api-tests.tavern_helpers:supplyChainFirstLevelBpn_is_as_expected
          extra_kwargs:
            expectedBpnl: BPNL00000003B6LU
      headers:
        content-type: application/json


---


test_name: Make sure first level supplier bpnl in investigation job with three level request has been detected correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation job with valid globalAssetId
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations"
      json:
        key:
          # Tested with Vehicle C
          globalAssetId: urn:uuid:1c7a25ea-0490-4944-b9c9-d8c666d47958
          bpn: BPNL00ARBITRARY4
        incidentBPNSs:
          - BPNS00ARBITRARY7
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_ESS_job_response_with_desired_test_steps_and_wait_up_to_15_minutes_for_COMPLETED

  - name: get response for created investigation and check results
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:supplyChainImpacted_is_as_expected
          extra_kwargs:
            expectedSupplyChainImpacted: "Yes"
        - function: local.testing.api-tests.tavern_helpers:ESS_job_parameter_are_as_requested
        - function: local.testing.api-tests.tavern_helpers:supplyChainFirstLevelBpn_is_as_expected
          extra_kwargs:
            expectedBpnl: BPNL00ARBITRARY5
      headers:
        content-type: application/json


---


test_name: Make sure first level supplier bpnl in investigation job with one level request has been detected correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation job with valid globalAssetId
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations"
      json:
        key:
          #tested with Vehicle D
          globalAssetId: urn:uuid:3a2a1ca9-c6c1-49c7-a7ae-1dfc5fb9881f
          bpn: BPNL00ARBITRARY8
        incidentBPNSs:
          - BPNS0ARBITRARY10
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_ESS_job_response_with_desired_test_steps_and_wait_up_to_15_minutes_for_COMPLETED

  - name: get response for created investigation and check results
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:supplyChainImpacted_is_as_expected
          extra_kwargs:
            expectedSupplyChainImpacted: "Yes"
        - function: local.testing.api-tests.tavern_helpers:ESS_job_parameter_are_as_requested
        - function: local.testing.api-tests.tavern_helpers:supplyChainFirstLevelBpn_is_as_expected
          extra_kwargs:
            expectedBpnl: BPNL00ARBITRARY10
      headers:
        content-type: application/json


---


test_name: Make sure one hop in several supplyChain impacted nodes has been detected as shortest correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation job with valid globalAssetId
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations"
      json:
        key:
          # Tested with Vehicle A on second level
          globalAssetId: urn:uuid:aad27ddb-43aa-4e42-98c2-01e529ef127c
          bpn: BPNL00ARBITRARY1
        bomLifecycle: asPlanned
        callbackUrl: http://testikus.com
        incidentBPNSs:
          - BPNS00000003B6LU
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_ESS_job_response_with_desired_test_steps_and_wait_up_to_15_minutes_for_COMPLETED

  - name: get response for created investigation and check results
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:supplyChainImpacted_is_as_expected
          extra_kwargs:
            expectedSupplyChainImpacted: "Yes"
        - function: local.testing.api-tests.tavern_helpers:ESS_job_parameter_are_as_requested
        - function: local.testing.api-tests.tavern_helpers:supplyChainhops_is_as_expected
          extra_kwargs:
            expectedHops: 1
      headers:
        content-type: application/json


---


test_name: Make sure three hops in supplyChain impacted investigation job has been detected correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation job with valid globalAssetId
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations"
      json:
        key:
          # Tested with Vehicle C
          globalAssetId: urn:uuid:1c7a25ea-0490-4944-b9c9-d8c666d47958
          bpn: BPNL00ARBITRARY4
        incidentBPNSs:
          - BPNS00ARBITRARY7
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_ESS_job_response_with_desired_test_steps_and_wait_up_to_15_minutes_for_COMPLETED

  - name: get response for created investigation and check results
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:supplyChainImpacted_is_as_expected
          extra_kwargs:
            expectedSupplyChainImpacted: "Yes"
        - function: local.testing.api-tests.tavern_helpers:ESS_job_parameter_are_as_requested
        - function: local.testing.api-tests.tavern_helpers:supplyChainhops_is_as_expected
          extra_kwargs:
            expectedHops: 3
      headers:
        content-type: application/json


---


test_name: Make sure one hops in supplyChain impacted investigation job has been detected correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation job with valid globalAssetId
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations"
      json:
        key:
          #tested with Vehicle D
          globalAssetId: urn:uuid:3a2a1ca9-c6c1-49c7-a7ae-1dfc5fb9881f
          bpn: BPNL00ARBITRARY8
        incidentBPNSs:
          - BPNS0ARBITRARY10
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_ESS_job_response_with_desired_test_steps_and_wait_up_to_15_minutes_for_COMPLETED

  - name: get response for created investigation and check results
    request:
      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:supplyChainImpacted_is_as_expected
          extra_kwargs:
            expectedSupplyChainImpacted: "Yes"
        - function: local.testing.api-tests.tavern_helpers:ESS_job_parameter_are_as_requested
        - function: local.testing.api-tests.tavern_helpers:supplyChainhops_is_as_expected
          extra_kwargs:
            expectedHops: 1
      headers:
        content-type: application/json

############################### \/ ESS Tests with T-Systems and submodel servers \/ ##############################
####### !!!!!! Commented out since there is no testdata available for the moment !!!!!! ######
#---
#
#
#test_name: Make sure investigation job with valid globalAssetId and BPN is processed correctly in T-Systems
#
#strict:
#  - headers:off
#  - json:off
#
#stages:
#  - name: register a BPN investigation job with valid globalAssetId to T-Systems
#    request:
#      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations"
#      json:
#        key:
#          globalAssetId: urn:uuid:c7a2b803-f8fe-4b79-b6fc-967ce847c9a9
#          bpn: BPNL00000003B0Q0
#        bomLifecycle: asPlanned
#        callbackUrl: http://testikus.com
#        incidentBPNSs:
#          - BPNL00000003B0Q0
#      method: POST
#      headers:
#        content-type: application/json
#        $ext:
#          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
#    response:
#      status_code: 201
#      headers:
#        content-type: application/json
#      save:
#        json:
#          job_id: id
#
#  - *verify_ESS_job_response_with_desired_test_steps_and_wait_up_to_15_minutes_for_COMPLETED
#
#  - name: get response for created investigation
#    request:
#      url: "{tavern.env_vars.IRS_ESS_HOST}/ess/bpn/investigations/{job_id}"
#      params:
#        returnUncompletedJob: true
#      method: GET
#      headers:
#        content-type: application/json
#        $ext:
#          function: local.testing.api-tests.tavern_helpers:create_api_key_ess
#    response:
#      status_code: 200
#      verify_response_with:
#        - function: local.testing.api-tests.tavern_helpers:supplyChainImpacted_is_as_expected
#          extra_kwargs:
#            expectedSupplyChainImpacted: "Yes"
#        - function: local.testing.api-tests.tavern_helpers:ESS_job_parameter_are_as_requested
#      headers:
#        content-type: application/json
#

############################## /\ ESS Tests with T-Systems and submodel servers /\ ##############################
###### !!!!!! Commented out since there is no testdata available for the moment !!!!!! ######
---


test_name: Make sure server process job after authorization (1.0.0)

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check for success
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_PLANNED}"
          bpn: "{tavern.env_vars.BPN_AS_PLANNED}"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id
    delay_after: 1

  - name: verify job response with desired test steps
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 206
      headers:
        content-type: application/json


---


test_name: Make sure job with status RUNNING is responsed with http code 206

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check for success
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_BUILT}"
          bpn: "{tavern.env_vars.BPN_AS_BUILT}"
        collectAspects: true
        depth: 2
        aspects:
          - SerialPart
        direction: "downward"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - name: verify running job is responsed with http code 206
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 206
      json:
        job:
          state: RUNNING


---


test_name: Make sure job with submodels process with status COMPLETED with asPlanned-id

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check for success
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_PLANNED}"
          bpn: "{tavern.env_vars.BPN_AS_PLANNED}"
        collectAspects: true
        bomLifecycle: asPlanned
        depth: 2
        aspects:
          - SingleLevelUsageAsPlanned
        direction: "downward"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - &verify_job_is_running_and_wait_up_to_15_minutes_for_COMPLETED
    name: verify job is running and wait for desired job status
    max_retries: 30
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      json:
        job:
          state: COMPLETED
    delay_after: 30

  - name: verify job response with desired test steps
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:submodels_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:check_timestamps_for_completed_jobs
      headers:
        content-type: application/json


---


test_name: Make sure job with submodels process with status COMPLETED with asBuilt-id

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check for success
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_BUILT}"
          bpn: "{tavern.env_vars.BPN_AS_BUILT}"
        collectAspects: true
        depth: 2
        aspects:
          - ProductDescription
          - CertificateOfDestruction
          - SerialPart
          - SingleLevelUsageAsBuilt
        direction: "downward"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_job_is_running_and_wait_up_to_15_minutes_for_COMPLETED

  - name: verify job response with desired test steps
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:submodels_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:check_timestamps_for_completed_jobs
      headers:
        content-type: application/json


---


test_name: Make sure job without submodels process with status COMPLETED

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check for success
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_BUILT}"
          bpn: "{tavern.env_vars.BPN_AS_BUILT}"
        collectAspects: true
        depth: 1
        direction: "downward"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_job_is_running_and_wait_up_to_15_minutes_for_COMPLETED

  - name: verify job response with desired test steps
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:submodels_are_empty
        - function: local.testing.api-tests.tavern_helpers:submodelDescriptors_in_shells_are_empty
        - function: local.testing.api-tests.tavern_helpers:aspects_in_job_parameter_are_empty
        - function: local.testing.api-tests.tavern_helpers:relationships_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:check_timestamps_for_completed_jobs
      headers:
        content-type: application/json


---


test_name: Make sure job request with invalid globalAssetId syntax return 400-response (1.1.0 + 1.1.1)

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check errors in response
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: urn:uuid:4ad4a1ce-beb2-42d2-bfe7c6xyz009123452
          bpn: "BPNL00000003AYRE"
        collectAspects: true
        depth: 1
        direction: "downward"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 400
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:errors_for_invalid_globalAssetId_are_correct
      json:
        statusCode: BAD_REQUEST
        error: Invalid Arguments.
      headers:
        content-type: application/json


---


test_name: Make sure job with depth and bomLifecycle is processed (1.2.0)

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check for success
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_PLANNED}"
          bpn: "{tavern.env_vars.BPN_AS_PLANNED}"
        bomLifecycle: "asPlanned"
        depth: 2
        collectAspects: true
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      json:
        id: !re_fullmatch "[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_job_is_running_and_wait_up_to_15_minutes_for_COMPLETED

  - name: verify job response with desired test steps and check details
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        #  - function: local.testing.api-tests.tavern_helpers:tombstones_are_empty
        - function: local.testing.api-tests.tavern_helpers:relationships_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:submodels_are_empty
        - function: local.testing.api-tests.tavern_helpers:check_timestamps_for_completed_jobs
      headers:
        content-type: application/json


---


test_name: Make sure job with aspect SerialPart is processed (1.3.0)

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check for success
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_BUILT}"
          bpn: "{tavern.env_vars.BPN_AS_BUILT}"
        aspects:
          - SerialPart
        collectAspects: true
        depth: 1
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      json:
        id: !re_fullmatch "[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_job_is_running_and_wait_up_to_15_minutes_for_COMPLETED

  - name: verify job response with desired test steps and check details
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        #- function: local.testing.api-tests.tavern_helpers:tombstones_are_empty
        - function: local.testing.api-tests.tavern_helpers:relationships_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:submodels_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:check_timestamps_for_completed_jobs
      headers:
        content-type: application/json


---


test_name: Make sure job with aspects SerialPart and ProductDescription is processed (1.3.1)

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check for success
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_BUILT}"
          bpn: "{tavern.env_vars.BPN_AS_BUILT}"
        aspects:
          - SerialPart
          - ProductDescription
        collectAspects: true
        depth: 2
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      json:
        id: !re_fullmatch "[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_job_is_running_and_wait_up_to_15_minutes_for_COMPLETED

  - name: verify job response with desired test steps and check details
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        #- function: local.testing.api-tests.tavern_helpers:tombstones_are_empty
        - function: local.testing.api-tests.tavern_helpers:relationships_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:submodels_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:check_timestamps_for_completed_jobs
      headers:
        content-type: application/json


---


test_name: Make sure job with aspects MaterialForRecycling is processed (1.3.2)

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check for success
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "urn:uuid:6d505432-8b31-4966-9514-4b753372683f"
          bpn: "BPNL00000003AVTH"
        aspects:
          - MaterialForRecycling
        collectAspects: true
        depth: 2
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      json:
        id: !re_fullmatch "[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_job_is_running_and_wait_up_to_15_minutes_for_COMPLETED

  - name: verify job response with desired test steps and check details
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        #- function: local.testing.api-tests.tavern_helpers:tombstones_are_empty
        - function: local.testing.api-tests.tavern_helpers:relationships_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:submodels_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:check_timestamps_for_completed_jobs
      headers:
        content-type: application/json


---


test_name: Make sure job with aspect Batch is processed (1.3.3)

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check for success
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "urn:uuid:397b63ae-89d7-4131-b45a-575e840dc5c5"
          bpn: "BPNL00000003AVTH"
        aspects:
          - Batch
        collectAspects: true
        bomLifecycle: "asBuilt"
        depth: 10
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      json:
        id: !re_fullmatch "[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_job_is_running_and_wait_up_to_15_minutes_for_COMPLETED

  - name: verify job response with desired test steps and check details
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        #- function: local.testing.api-tests.tavern_helpers:tombstones_are_empty
        - function: local.testing.api-tests.tavern_helpers:relationships_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:submodels_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:check_timestamps_for_completed_jobs
      headers:
        content-type: application/json


---


test_name: Make sure job with aspects SerialPart and CertificateOfDestruction is processed (1.3.4)

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check for success
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_BUILT}"
          bpn: "{tavern.env_vars.BPN_AS_BUILT}"
        aspects:
          - SerialPart
          - CertificateOfDestruction
        collectAspects: true
        depth: 2
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      json:
        id: !re_fullmatch "[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_job_is_running_and_wait_up_to_15_minutes_for_COMPLETED

  - name: verify job response with desired test steps and check details
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        # - function: local.testing.api-tests.tavern_helpers:tombstones_are_empty
        - function: local.testing.api-tests.tavern_helpers:relationships_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:submodels_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:check_timestamps_for_completed_jobs
      headers:
        content-type: application/json


---


test_name: Make sure job with invalid aspects is giving the correct error message (1.4.1)

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check for success
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_PLANNED}"
          bpn: "{tavern.env_vars.BPN_AS_PLANNED}"
        aspects:
          - UnknownAspect
        collectAspects: true
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 400
      json:
        statusCode: BAD_REQUEST
        error: "Aspects did not match the available aspects: '[UnknownAspect]'"
        messages: null
      headers:
        content-type: application/json


---


test_name: Make sure job can be returned correctly with returnUncompletedJob = true

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check for success
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_BUILT}"
          bpn: "{tavern.env_vars.BPN_AS_BUILT}"
        aspects:
          - ProductDescription
          - CertificateOfDestruction
          - SerialPart
          - SingleLevelUsageAsBuilt
          - BatteryPass
          - IdConversion
          - MarketplaceOffer
          - MaterialForRecycling
          - ReturnRequest
          - CertificateOfDestruction
          - CertificateOfDismantler
        collectAspects: true
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      json:
        id: !re_fullmatch "[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"
      headers:
        content-type: application/json
      save:
        json:
          job_id: id
    delay_after: 60

  - name: fetch response for running job and check existence of submodels and relationships
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 206
      json:
        job:
          state: RUNNING
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:relationships_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:submodels_are_not_empty
      headers:
        content-type: application/json


---


test_name: Make sure job request with invalid depth return 400-response

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check errors in response
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_BUILT}"
          bpn: "{tavern.env_vars.BPN_AS_BUILT}"
        collectAspects: true
        depth: -10
        direction: "downward"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 400
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:errors_for_invalid_depth_are_correct
      json:
        statusCode: BAD_REQUEST
        error: Invalid Arguments.
      headers:
        content-type: application/json


---


test_name: Make sure job with all valid aspects is processed (1.5.0)

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check for success
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_BUILT}"
          bpn: "{tavern.env_vars.BPN_AS_BUILT}"
        aspects:
          - SerialPart
          - SingleLevelBomAsBuilt
          - Batch
          - ProductDescription
          - IdConversion
          - MarketplaceOffer
          - MaterialForRecycling
          - ReturnRequest
          - CertificateOfDestruction
          - CertificateOfDismantler
          - EndOfLife
          - EsrCertificate
          - EsrCertificateStateStatistic
          - AddressAspect
          - ClaimData
          - BatteryPass
          - DiagnosticData
          - MaterialForHomologation
          - PartAsPlanned
        collectAspects: true
        depth: 2
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      json:
        id: !re_fullmatch "[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"
      headers:
        content-type: application/json
      save:
        json:
          job_id: id
    delay_after: 300

  - *verify_job_is_running_and_wait_up_to_15_minutes_for_COMPLETED

  - name: verify job response with desired test steps and check details
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        # - function: local.testing.api-tests.tavern_helpers:tombstones_are_empty
        - function: local.testing.api-tests.tavern_helpers:relationships_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:submodels_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:check_timestamps_for_completed_jobs
      headers:
        content-type: application/json


  #---
  #
  #
  #test_name: Make sure job with DEPRECATED Catena-X semantichub aspect is processed as expected
  #
  #strict:
  #  - headers:off
  #  - json:off
  #
  #marks:
  #  - parametrize:
  #      key:
  #        deprecated_aspect
  #      vals:
  #        - VehicleDiagnosticDataQuality
  #        - PcfCore
  #        - PcfSupplyRelation
  #        - PcfTechnical
  #        - ContactInformation
  #
  #stages:
  #  - name: create a job and check for success
  #    request:
  #      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
  #      json:
  #        key:
  #          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_BUILT}"
  #          bpn: "{tavern.env_vars.BPN_AS_BUILT}"
  #        aspects:
  #          - "{deprecated_aspect}"
  #        collectAspects: true
  #      method: POST
  #      headers:
  #        content-type: application/json
  #        $ext:
  #          function: local.testing.api-tests.tavern_helpers:create_api_key
  #    response:
  #      status_code: 400
  #      json:
  #        statusCode: BAD_REQUEST
  #        error: "Aspects did not match the available aspects: '[{deprecated_aspect}]'"
  ##        messages: null
  #     headers:
  #       content-type: application/json


---


test_name: Make sure search for COMPLETED jobs only returns COMPLETED status (2.0.0)

strict:
  - headers:off
  - json:off

stages:
  - name: get all COMPLETED jobs
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs?states=COMPLETED"
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:status_of_jobs_are_as_expected
        extra_kwargs:
          expected_status: COMPLETED
      headers:
        content-type: application/json


---


test_name: Make sure search for ERROR jobs only returns ERROR status (2.0.1)

strict:
  - headers:off
  - json:off

stages:
  - name: get all ERROR jobs
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs?states=ERROR"
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:status_of_jobs_are_as_expected
        extra_kwargs:
          expected_status: ERROR
      headers:
        content-type: application/json


---


test_name: Make sure search for INITIAL jobs only returns INITIAL status (2.0.2)

strict:
  - headers:off
  - json:off

stages:
  - name: get all INITIAL jobs
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs?states=INITIAL"
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:status_of_jobs_are_as_expected
        extra_kwargs:
          expected_status: INITIAL
      headers:
        content-type: application/json


---


test_name: Make sure search for RUNNING jobs only returns RUNNING status (2.1.0)

strict:
  - headers:off
  - json:off

stages:
  - name: create a job for the next step
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_BUILT}"
          bpn: "{tavern.env_vars.BPN_AS_BUILT}"
        aspects:
          - SerialPart
        collectAspects: true
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      headers:
        content-type: application/json

  - name: get all RUNNING jobs
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs?states=RUNNING"
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:status_of_jobs_are_as_expected
        extra_kwargs:
          expected_status: RUNNING
      headers:
        content-type: application/json


---


test_name: Make sure search for all jobs returns all status (2.0.3)

strict:
  - headers:off
  - json:off

stages:
  - name: get all jobs
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:status_of_all_jobs_are_given
      headers:
        content-type: application/json


---


test_name: Check if error message for searching a job with too long job-ID is correct (3.1.1)

strict:
  - headers:off
  - json:off

stages:
  - name: get job for unknown globalAssetId
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/bc1b4f4f-aa00-4296-8738-e7913c95f2d99"
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 400
      json:
        statusCode: BAD_REQUEST
        error: UUID string too large
      headers:
        content-type: application/json


---


test_name: Check if error message for searching a job with unknown job-ID is correct (3.1.2)

strict:
  - headers:off
  - json:off

stages:
  - name: get job for unknown globalAssetId
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/bc1b4f4f-aa00-4296-8738-e7913c95f2d9"
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 404
      json:
        statusCode: NOT_FOUND
        error: Not Found
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:errors_for_unknown_requested_globalAssetId_are_correct
      headers:
        content-type: application/json


---


test_name: Make sure search for all jobs returns startTime for all status

strict:
  - headers:off
  - json:off

stages:
  - name: get all jobs
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:check_startedOn_timestamp_exists
      headers:
        content-type: application/json


---


test_name: Make sure cancellation of irs-job works correct

strict:
  - headers:off
  - json:off

stages:
  - name: create a job
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_BUILT}"
          bpn: "{tavern.env_vars.BPN_AS_BUILT}"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - name: cancel the job
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      method: PUT
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      headers:
        content-type: application/json

  - name: verify job response with desired test steps
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      json:
        job:
          state: CANCELED
      headers:
        content-type: application/json


---


test_name: Make sure search for running jobs returns no completedOn timestamp

strict:
  - headers:off
  - json:off

stages:
  - name: get all jobs with status UNSAVED, INITIAL, RUNNING, TRANSFERS_FINISHED and CANCELED
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs?states=UNSAVED, INITIAL, RUNNING, TRANSFERS_FINISHED, CANCELED"
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:check_startedOn_timestamp_exists
        - function: local.testing.api-tests.tavern_helpers:check_completedOn_timestamp_not_exists
      headers:
        content-type: application/json


---


test_name: Make sure search for completed jobs returns completedOn timestamp

strict:
  - headers:off
  - json:off

stages:
  - name: get all jobs with status COMPLETED and ERROR
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs?states=COMPLETED, ERROR"
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:check_startedOn_timestamp_exists
        - function: local.testing.api-tests.tavern_helpers:check_completedOn_timestamp_exists
      headers:
        content-type: application/json


---


test_name: Make sure search for completed jobs returns startedOn timestamp smaller than completedOn timestamp

strict:
  - headers:off
  - json:off

stages:
  - name: get all jobs with status COMPLETED and ERROR
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs?states=COMPLETED, ERROR"
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:check_startedOn_timestamp_exists
        - function: local.testing.api-tests.tavern_helpers:check_completedOn_timestamp_exists
        - function: local.testing.api-tests.tavern_helpers:check_startedOn_is_smaller_than_completedOn
      headers:
        content-type: application/json


---


test_name: Make sure job with bomLifecycle asPlanned + asBuilt get correct error response

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check error in response
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_BUILT}"
          bpn: "{tavern.env_vars.BPN_AS_BUILT}"
        collectAspects: true
        depth: 1
        direction: "downward"
        bomLifecycle: "asPlanned, asBuilt"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 400
      json:
        statusCode: BAD_REQUEST
        error: "NoSuchElementException: Unsupported BomLifecycle: asPlanned, asBuilt. Must be one of: asBuilt, asPlanned, asSpecified"
        messages: null
      headers:
        content-type: application/json


---


test_name: Make sure job with unknown globalAssetId are responsed with correct tombstone

strict:
  - headers:off
  - json:off

stages:
  - name: create a job with unknown globalAssetId
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: urn:uuid:cce14502-958a-42e1-8bb7-f4f41aaaaaaa
          bpn: "BPNL00000003AYRE"
        collectAspects: true
        depth: 1
        direction: "downward"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_job_is_running_and_wait_up_to_15_minutes_for_COMPLETED

  - name: verify job response with desired test steps
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:submodels_are_empty
        - function: local.testing.api-tests.tavern_helpers:relationships_are_empty
        - function: local.testing.api-tests.tavern_helpers:check_timestamps_for_completed_jobs
        - function: local.testing.api-tests.tavern_helpers:errors_for_unknown_globalAssetId_are_correct
      headers:
        content-type: application/json


---


test_name: Make sure pagination details exist as expected

strict:
  - headers:off
  - json:off

stages:
  - name: get all jobs
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:check_pagination_details_exists
      headers:
        content-type: application/json


---


test_name: Make sure pagination can be requested as expected

strict:
  - headers:off
  - json:off

stages:
  - name: get all jobs with requested pagination settings
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs?page=1&size=3&sort=jobCompleted,asc"
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:check_pagination_is_requested_correctly
      headers:
        content-type: application/json


---


test_name: Make sure requested parameter has been set correctly

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check for success
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_PLANNED}"
          bpn: "{tavern.env_vars.BPN_AS_PLANNED}"
        collectAspects: true
        depth: 2
        direction: "downward"
        bomLifecycle: "asPlanned"
        lookupBPNs: true
        callbackUrl: "https://www.check123.com"
        aspects:
          - SerialPart
          - PartAsPlanned
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id
    delay_after: 1

  - name: verify job response with desired test steps
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 206
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:job_parameter_are_as_requested
      headers:
        content-type: application/json


---


test_name: Make sure IRS-jobs are running without BPN-lookups by default

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check for success
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_BUILT}"
          bpn: "{tavern.env_vars.BPN_AS_BUILT}"
        collectAspects: false
        depth: 1
        direction: "downward"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_job_is_running_and_wait_up_to_15_minutes_for_COMPLETED

  - name: verify job response with desired test steps
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:bpns_are_empty
      headers:
        content-type: application/json


---


test_name: Make sure IRS-jobs are running with BPN-lookups correctly

strict:
  - headers:off
  - json:off

stages:
  - name: create a job with lookupBPNs = true and wait
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_BUILT}"
          bpn: "{tavern.env_vars.BPN_AS_BUILT}"
        collectAspects: false
        lookupBPNs: true
        depth: 1
        direction: "downward"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_job_is_running_and_wait_up_to_15_minutes_for_COMPLETED

  - name: verify job response with desired test steps
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:bpns_are_not_empty
      headers:
        content-type: application/json


---


test_name: Make sure IRS-jobs with BPN-lookups content summary information

strict:
  - headers:off
  - json:off

stages:
  - name: create a job with lookupBPNs = true and wait
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_BUILT}"
          bpn: "{tavern.env_vars.BPN_AS_BUILT}"
        collectAspects: false
        lookupBPNs: true
        depth: 1
        direction: "downward"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_job_is_running_and_wait_up_to_15_minutes_for_COMPLETED

  - name: verify job response with desired test steps
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:bpns_are_not_empty
        - function: local.testing.api-tests.tavern_helpers:summary_for_bpns_is_given
      headers:
        content-type: application/json


---

############################## \/  Batch-Order tests for both irs/orders and irs/ess/orders  \/ ##############################

test_name: Make sure batch-job with several valid globalAssetIds has been requested correctly

strict:
  - headers:off
  - json:off

stages:
  - name: create a batch job with several valid globalAssetIds
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/orders"
      json:
        keys:
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:0733946c-59c6-41ae-9570-cb43a6e4c79e
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:1b17682e-5e2a-4913-aa1b-7d59a072a3cb
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:ed333e9a-5afa-40b2-99da-bae2fd21501e
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:a0f6803c-e4dc-4cda-8ad2-91cc57868449
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:fa5804f1-8d4e-437c-aca2-a5491be61758
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:cc8e9448-b294-46e7-8110-337e8bfa3001
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:1e35e091-3d3d-421e-9c7e-14cf1c9442a6
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:0ea1aa79-10d4-4df1-8a5a-5b7eafd26163
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:61a22b1c-5725-41fb-8e1e-dccaaba83838
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:8914a66e-b59b-405f-afff-b97d71ebece3
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:7b87f5d6-f75e-40f1-a439-779ae9f57a21
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:a4a26b9c-9460-4cc5-8645-85916b86adb0
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:ceb6b964-5779-49c1-b5e9-0ee70528fcbd
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:8f9d8c7f-6d7a-48f1-9959-9fa3a1a7a891
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:b21cfd5b-dcf4-46fa-9227-3eb693567dd8
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:a1082992-cc3b-4da1-af6b-aa692ed71461
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:d3c0bf85-d44f-47c5-990d-fec8a36065c6
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:88f51be1-3771-4335-8b5c-4c5050123127
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:07e0997f-4212-4456-8f27-164b30fc8355
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:73173bf5-08df-4898-9d6d-8899015c161e
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:3db730be-9de5-4db5-a58d-684de36484e7
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:771d2ccc-a081-4d3a-bcb2-46c6a0a33743
        aspects:
          - "SingleLevelBomAsBuilt"
          - "SerialPart"
        collectAspects: true
        lookupBPNs: true
        batchSize: 10
        batchStrategy: "PRESERVE_BATCH_JOB_ORDER"
        depth: 1
        direction: "downward"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - name: verify job response with desired test steps
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/orders/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:order_informations_for_batchprocessing_are_given
        extra_kwargs:
          amount_batches: 3
      headers:
        content-type: application/json


---


test_name: Make sure batch-job with invalid request data has been responsed correctly

strict:
  - headers:off
  - json:off

stages:
  - name: create a batch job with several valid globalAssetIds but invalid batchSize and check response
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/orders"
      json:
        globalAssetIds:
          - urn:uuid:771d2ccc-a081-4d3a-bcb2-46c6a0a33743
          - urn:uuid:3db730be-9de5-4db5-a58d-684de36484e7
          - urn:uuid:73173bf5-08df-4898-9d6d-8899015c161e
        aspects:
          - "SingleLevelBomAsBuilt"
          - "SerialPart"
        collectAspects: true
        lookupBPNs: true
        batchSize: 2
        batchStrategy: "PRESERVE_BATCH_JOB_ORDER"
        depth: 1
        direction: "downward"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 400
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:errors_for_invalid_batchSize_are_correct
      json:
        statusCode: BAD_REQUEST
        error: Invalid Arguments.
      headers:
        content-type: application/json


---


test_name: Make sure cancellation of batch-job has been processed correctly

strict:
  - headers:off
  - json:off

stages:
  - name: create a batch job with several valid globalAssetIds
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/orders"
      json:
        keys:
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:0733946c-59c6-41ae-9570-cb43a6e4c79e
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:1b17682e-5e2a-4913-aa1b-7d59a072a3cb
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:ed333e9a-5afa-40b2-99da-bae2fd21501e
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:a0f6803c-e4dc-4cda-8ad2-91cc57868449
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:fa5804f1-8d4e-437c-aca2-a5491be61758
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:cc8e9448-b294-46e7-8110-337e8bfa3001
        aspects:
          - "SingleLevelBomAsBuilt"
          - "SerialPart"
        collectAspects: true
        lookupBPNs: true
        batchSize: 10
        batchStrategy: "PRESERVE_BATCH_JOB_ORDER"
        depth: 1
        direction: "downward"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - name: verify job response with desired test steps and get batchId
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/orders/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:order_informations_for_batchprocessing_are_given
        extra_kwargs:
          amount_batches: 1
      headers:
        content-type: application/json
      save:
        $ext:
          function: local.testing.api-tests.tavern_helpers:getBatchId
          extra_kwargs:
            batchId_number: 0

  - name: cancel order job
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/orders/{job_id}"
      method: PUT
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      headers:
        content-type: application/json

  - name: get batch response of desired batch
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/orders/{job_id}/batches/{batch_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:check_batches_are_canceled_correctly
      headers:
        content-type: application/json


---


test_name: Make sure ESS-investigation batch-job with valid globalAssetId and BPN has been requested correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation batch job with valid globalAssetId
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/ess/orders"
      json:
        keys:
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:0733946c-59c6-41ae-9570-cb43a6e4c79e
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:1b17682e-5e2a-4913-aa1b-7d59a072a3cb
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:ed333e9a-5afa-40b2-99da-bae2fd21501e
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:a0f6803c-e4dc-4cda-8ad2-91cc57868449
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:fa5804f1-8d4e-437c-aca2-a5491be61758
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:cc8e9448-b294-46e7-8110-337e8bfa3001
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:1e35e091-3d3d-421e-9c7e-14cf1c9442a6
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:0ea1aa79-10d4-4df1-8a5a-5b7eafd26163
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:61a22b1c-5725-41fb-8e1e-dccaaba83838
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:8914a66e-b59b-405f-afff-b97d71ebece3
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:7b87f5d6-f75e-40f1-a439-779ae9f57a21
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:a4a26b9c-9460-4cc5-8645-85916b86adb0
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:ceb6b964-5779-49c1-b5e9-0ee70528fcbd
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:8f9d8c7f-6d7a-48f1-9959-9fa3a1a7a891
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:b21cfd5b-dcf4-46fa-9227-3eb693567dd8
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:a1082992-cc3b-4da1-af6b-aa692ed71461
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:d3c0bf85-d44f-47c5-990d-fec8a36065c6
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:88f51be1-3771-4335-8b5c-4c5050123127
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:07e0997f-4212-4456-8f27-164b30fc8355
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:73173bf5-08df-4898-9d6d-8899015c161e
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:3db730be-9de5-4db5-a58d-684de36484e7
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:771d2ccc-a081-4d3a-bcb2-46c6a0a33743
        incidentBPNSs:
          - BPNS00000003B6LU
        batchSize: 10
        batchStrategy: "PRESERVE_BATCH_JOB_ORDER"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - name: get response for created investigation
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/orders/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:order_informations_for_batchprocessing_are_given
        extra_kwargs:
          amount_batches: 3
      headers:
        content-type: application/json


---


test_name: Make sure ESS-investigation batch-job with invalid request data has been responsed correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation batch job with several valid globalAssetIds but invalid batchSize and check response
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/ess/orders"
      json:
        keys:
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:0733946c-59c6-41ae-9570-cb43a6e4c79e
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:1b17682e-5e2a-4913-aa1b-7d59a072a3cb
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:ed333e9a-5afa-40b2-99da-bae2fd21501e
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:a0f6803c-e4dc-4cda-8ad2-91cc57868449
        incidentBPNSs:
          - BPNS00000003B6LU
        batchSize: 2
        batchStrategy: "PRESERVE_BATCH_JOB_ORDER"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 400
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:errors_for_invalid_batchSize_are_correct
      json:
        statusCode: BAD_REQUEST
        error: Invalid Arguments.
      headers:
        content-type: application/json


---


test_name: Make sure cancellation of ESS-investigation batch-job has been processed correctly

strict:
  - headers:off
  - json:off

stages:
  - name: register a BPN investigation batch job with valid globalAssetId
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/ess/orders"
      json:
        keys:
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:0733946c-59c6-41ae-9570-cb43a6e4c79e
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:1b17682e-5e2a-4913-aa1b-7d59a072a3cb
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:ed333e9a-5afa-40b2-99da-bae2fd21501e
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:a0f6803c-e4dc-4cda-8ad2-91cc57868449
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:fa5804f1-8d4e-437c-aca2-a5491be61758
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:cc8e9448-b294-46e7-8110-337e8bfa3001
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:1e35e091-3d3d-421e-9c7e-14cf1c9442a6
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:0ea1aa79-10d4-4df1-8a5a-5b7eafd26163
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:61a22b1c-5725-41fb-8e1e-dccaaba83838
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:8914a66e-b59b-405f-afff-b97d71ebece3
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:7b87f5d6-f75e-40f1-a439-779ae9f57a21
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:a4a26b9c-9460-4cc5-8645-85916b86adb0
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:ceb6b964-5779-49c1-b5e9-0ee70528fcbd
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:8f9d8c7f-6d7a-48f1-9959-9fa3a1a7a891
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:b21cfd5b-dcf4-46fa-9227-3eb693567dd8
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:a1082992-cc3b-4da1-af6b-aa692ed71461
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:d3c0bf85-d44f-47c5-990d-fec8a36065c6
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:88f51be1-3771-4335-8b5c-4c5050123127
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:07e0997f-4212-4456-8f27-164b30fc8355
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:73173bf5-08df-4898-9d6d-8899015c161e
          - bpn: "BPNL00000003AVTH"
            globalAssetId: urn:uuid:3db730be-9de5-4db5-a58d-684de36484e7
          - bpn: "BPNL00000003AYRE"
            globalAssetId: urn:uuid:771d2ccc-a081-4d3a-bcb2-46c6a0a33743
        incidentBPNSs:
          - BPNS00000003B6LU
        batchSize: 10
        batchStrategy: "PRESERVE_BATCH_JOB_ORDER"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - name: get response for created investigation
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/orders/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:order_informations_for_batchprocessing_are_given
        extra_kwargs:
          amount_batches: 3
      headers:
        content-type: application/json
      save:
        $ext:
          function: local.testing.api-tests.tavern_helpers:getBatchId
          extra_kwargs:
            batchId_number: 1

  - name: cancel order job
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/orders/{job_id}"
      method: PUT
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      headers:
        content-type: application/json

  - name: get batch response of desired batch
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/orders/{job_id}/batches/{batch_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        function: local.testing.api-tests.tavern_helpers:check_batches_are_canceled_correctly
      headers:
        content-type: application/json


---


test_name: Make sure jobs are responsed with contractAgreementIds in shells and submodels if auditContractNegotiation activated

strict:
  - headers:off
  - json:off

stages:
    - name: create a job and check for success
      request:
        url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
        json:
          key:
            globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_BUILT}"
            bpn: "{tavern.env_vars.BPN_AS_BUILT}"
          collectAspects: true
          auditContractNegotiation: true
          depth: 2
          aspects:
            - SerialPart
          direction: "downward"
        method: POST
        headers:
          content-type: application/json
          $ext:
            function: local.testing.api-tests.tavern_helpers:create_api_key
      response:
        status_code: 201
        headers:
          content-type: application/json
        save:
          json:
            job_id: id

    - *verify_job_is_running_and_wait_up_to_15_minutes_for_COMPLETED

    - name: verify job response with desired test steps
      request:
        url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
        params:
          returnUncompletedJob: true
        method: GET
        headers:
          content-type: application/json
          $ext:
            function: local.testing.api-tests.tavern_helpers:create_api_key
      response:
        status_code: 200
        verify_response_with:
          - function: local.testing.api-tests.tavern_helpers:contractAgreementId_in_shells_existing
          - function: local.testing.api-tests.tavern_helpers:contractAgreementId_in_submodels_existing
        headers:
          content-type: application/json


---


test_name: Make sure jobs are not responsed with contractAgreementIds in shells and submodels if auditContractNegotiation deactivated

strict:
  - headers:off
  - json:off

stages:
  - name: create a job and check for success
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs"
      json:
        key:
          globalAssetId: "{tavern.env_vars.GLOBAL_ASSET_ID_AS_BUILT}"
          bpn: "{tavern.env_vars.BPN_AS_BUILT}"
        collectAspects: true
        auditContractNegotiation: false
        depth: 2
        aspects:
          - SerialPart
        direction: "downward"
      method: POST
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - *verify_job_is_running_and_wait_up_to_15_minutes_for_COMPLETED

  - name: verify job response with desired test steps
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/jobs/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        $ext:
          function: local.testing.api-tests.tavern_helpers:create_api_key
    response:
      status_code: 200
      verify_response_with:
        - function: local.testing.api-tests.tavern_helpers:contractAgreementId_in_shells_not_existing
        - function: local.testing.api-tests.tavern_helpers:contractAgreementId_in_submodels_not_existing
      headers:
        content-type: application/json